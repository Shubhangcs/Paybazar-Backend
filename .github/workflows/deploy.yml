name: Simple Build & Deploy to DO VM (no systemd)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # --- Checkout code ---
      - name: Checkout
        uses: actions/checkout@v4

      # --- Install Go ---
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      # --- Build binary using Makefile ---
      - name: Build release binary
        run: make build

      # --- Prepare deploy folder ---
      - name: Prepare deploy folder
        run: |
          rm -rf deploy || true
          mkdir -p deploy

          cp .build/paybazar_release deploy/

          cat > deploy/.env <<EOF
MODE="${{ secrets.MODE }}"
DATABASE_URL="${{ secrets.DATABASE_URL }}"
SERVER_PORT="${{ secrets.SERVER_PORT }}"
RKIT_API_TOKEN="${{ secrets.RKIT_API_TOKEN }}"
TWILIO_ACCOUNT_SID="${{ secrets.TWILIO_ACCOUNT_SID }}"
TWILIO_AUTH_TOKEN="${{ secrets.TWILIO_AUTH_TOKEN }}"
TWILIO_PHONE_NUMBER="${{ secrets.TWILIO_PHONE_NUMBER }}"
EOF

          chmod 600 deploy/.env
          chmod +x deploy/paybazar_release

      # --- SSH setup with passphrase ---
      - name: Start ssh-agent
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          ssh-passphrase: ${{ secrets.SSH_KEY_PASSPHRASE }}

      # --- Copy files to VM ---
      - name: Upload deploy folder to VM
        env:
          REMOTE_USER: ${{ secrets.DO_SSH_USER }}
          REMOTE_HOST: ${{ secrets.DO_HOST }}
        run: |
          sudo apt-get update -y
          sudo apt-get install -y rsync

          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

          rsync -avz -e "ssh $SSH_OPTS" ./deploy/ \
            ${REMOTE_USER}@${REMOTE_HOST}:~/deploy/

      # --- Run the binary in background ---
      - name: Run binary on VM
        env:
          REMOTE_USER: ${{ secrets.DO_SSH_USER }}
          REMOTE_HOST: ${{ secrets.DO_HOST }}
        run: |
          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

          ssh $SSH_OPTS ${REMOTE_USER}@${REMOTE_HOST} << 'EOF'
            set -e

            cd ~/deploy

            # Ensure final binary name is "paybazar"
            mv -f paybazar_release paybazar
            chmod +x paybazar

            # Kill any existing running instance
            if pgrep -f "deploy/paybazar" >/dev/null 2>&1; then
              echo "Stopping existing instance..."
              pkill -f "deploy/paybazar" || true
              sleep 1
            fi

            # Load environment variables
            set -a
            . .env
            set +a

            # Start app in background
            nohup ./paybazar >> paybazar.log 2>&1 &

            sleep 0.5

            echo "Running PID(s):"
            pgrep -f "deploy/paybazar" || true

            echo "Latest logs:"
            tail -n 10 paybazar.log || true
EOF
